# 数据存储设计文档

## 📋 概述

本文档详细说明了运费公斤段分析系统的数据存储设计方案，包括字段映射、数据结构、以及如何支持每日数据上传。

---

## 🗂️ 数据模型设计

### FreightRecord（运费记录）

这是系统的核心数据模型，存储每一条运费订单的详细信息。

```typescript
interface FreightRecord {
  id?: string;              // 唯一标识符
  orderNumber: string;      // 订单号（物流单号）
  weight: number;           // 重量（kg）
  cost: number;             // 运费成本（元）
  destination: string;      // 目的地（省-市）
  carrier?: string;         // 承运商（物流公司）
  date: Date;              // 日期（出库时间）
  weightRange?: string;    // 重量段（如：2-3kg）
  remarks?: string;        // 备注（平台、店铺等信息）
}
```

---

## 📊 Excel → 数据库字段映射

从您的Excel文件（报表运费10月.xlsx）到数据库的字段映射关系：

| Excel 列名 | 数据库字段 | 数据类型 | 说明 |
|-----------|-----------|---------|------|
| 计算重量 | `weight` | Number | 订单的计算重量，单位kg |
| 运费 | `cost` | Number | 实际运费成本，单位元 |
| 出库单时间 | `date` | Date | 订单出库时间（转换Excel日期格式） |
| 物流单号 | `orderNumber` | String | 主要订单号标识 |
| 内部订单号 | `orderNumber` | String | 备用订单号（物流单号为空时使用） |
| 物流公司 | `carrier` | String | 承运商名称 |
| 系统收货省份 | `destination` | String | 组合为"省-市"格式 |
| 系统收货城市 | `destination` | String | 组合为"省-市"格式 |
| 公斤段 | `weightRange` | String | Excel已分好的重量段 |
| 平台 | `remarks` | String | 组合到备注中 |
| 店铺 | `remarks` | String | 组合到备注中 |
| 订单类型 | `remarks` | String | 组合到备注中 |

---

## 🔄 数据导入流程

### 1. 自动导入（服务器启动时）

```bash
# 启动服务器，自动加载 docs/报表运费10月.xlsx
cd backend
npm run dev
```

**导入过程：**
1. 读取Excel文件（支持多工作表）
2. 提取第一个工作表的数据
3. 数据清洗和验证
   - 过滤无效记录（重量或运费≤0）
   - 转换Excel日期格式
   - 组合地址字段
4. 批量写入内存存储
5. 显示统计信息

### 2. 手动导入

```bash
# 单独运行导入脚本
cd backend
npm run import
```

---

## 📈 当前数据统计（2025年10月）

### 总体数据
- **总记录数**: 161,853 条
- **有效记录**: 161,853 条（过滤223条无效）
- **总运费**: ¥943,110.89
- **平均运费**: ¥5.83/单
- **日期范围**: 2025/10/1 ~ 2025/10/27

### 重量分布
| 重量段 | 订单数 | 占比 |
|--------|-------|------|
| 2-3kg | 50,924 | 31.46% |
| 9-10.8kg | 49,407 | 30.53% |
| 4-5kg | 22,410 | 13.85% |
| 10.8kg以上 | 19,668 | 12.15% |
| 1-2kg | 11,185 | 6.91% |
| 0-0.5kg | 6,346 | 3.92% |

### 物流公司分布（Top 10）
| 物流公司 | 订单数 | 占比 |
|---------|-------|------|
| 圆通速递 | 104,126 | 64.3% |
| 申通E物流 | 19,011 | 11.7% |
| 极兔速递 | 13,020 | 8.0% |
| 申通大件 | 10,439 | 6.5% |
| 申通小件 | 8,639 | 5.3% |

---

## 🔍 数据验证规则

### 必填字段验证
```typescript
// 重量和运费必须大于0
if (weight <= 0 || cost <= 0 || isNaN(weight) || isNaN(cost)) {
  // 跳过此记录
  return null;
}
```

### 日期处理
```typescript
// Excel日期转换（从1900-01-01开始的天数）
if (typeof excelDate === 'number') {
  date = new Date((excelDate - 25569) * 86400 * 1000);
}
```

### 默认值处理
- 订单号为空：使用内部订单号
- 省份/城市为空：填充"未知"
- 物流公司为空：填充"未知"
- 重量段为空：根据重量自动计算

---

## 📅 每日数据上传方案

### 方案一：替换式上传（当前实现）

**适用场景**: 每次上传完整月度数据

```bash
# 1. 替换 docs/报表运费XX月.xlsx
# 2. 重启服务器
cd backend
npm run dev
```

**优点**:
- 简单直接
- 数据完整性好
- 避免重复数据

**缺点**:
- 需要重启服务器
- 不保留历史数据

### 方案二：增量式上传（推荐未来实现）

**适用场景**: 每天上传当日新增数据

**实现要点**:
1. 添加唯一性约束（基于订单号+日期）
2. 检查重复记录
3. 仅导入新数据
4. 实时更新统计

**建议字段组合作为唯一标识**:
```typescript
uniqueKey = `${orderNumber}_${date.toISOString().split('T')[0]}`
```

---

## 🎯 数据查询优化

### 常用查询场景

#### 1. 按日期范围查询
```typescript
GET /api/analytics?startDate=2025-10-01&endDate=2025-10-31
```

#### 2. 按物流公司筛选
```typescript
GET /api/analytics?carrier=圆通速递
```

#### 3. 按重量段统计
```typescript
GET /api/analytics
// 返回数据中包含 weightRanges 数组
```

#### 4. 获取原始记录
```typescript
GET /api/analytics/records
```

---

## 💾 存储方案说明

### 当前方案：内存存储

**特点**:
- ✅ 启动快速，无需配置
- ✅ 查询性能极佳（16万记录瞬时响应）
- ✅ 适合单机部署
- ❌ 重启后数据丢失（需重新加载Excel）
- ❌ 数据量受内存限制

**适用场景**:
- 开发测试
- 小规模部署（<50万记录）
- 数据可以从Excel重新加载

### 未来扩展：MongoDB 存储

**优势**:
- ✅ 数据持久化
- ✅ 支持海量数据
- ✅ 分布式部署
- ✅ 丰富的查询功能

**迁移步骤**:
1. 安装 MongoDB
2. 取消注释 `backend/src/models/FreightModel.ts` 中的代码
3. 修改 `.env` 配置 `MONGODB_URI`
4. 使用 `FreightModel` 替代 `memoryStorage`

---

## 🔧 性能优化记录

### 大数据量优化（16万+记录）

#### 问题1: 批量插入堆栈溢出
```typescript
// ❌ 错误写法（spread 操作符会堆栈溢出）
records.push(...newRecords);

// ✅ 正确写法（使用循环）
for (const record of newRecords) {
  records.push(record);
}
```

#### 问题2: Math.min/max 堆栈溢出
```typescript
// ❌ 错误写法
const minDate = Math.min(...dates);

// ✅ 正确写法（单次遍历）
let minTimestamp = Infinity;
for (const record of records) {
  const timestamp = record.date.getTime();
  if (timestamp < minTimestamp) minTimestamp = timestamp;
}
```

---

## 📝 数据质量报告

### 当前数据质量
- **有效率**: 99.86% (161,853/162,076)
- **无效记录**: 223 条
- **无效原因**: 
  - 重量为0或负数
  - 运费为0或负数
  - 数据格式错误

### 数据完整性
- ✅ 所有有效记录都有重量和运费
- ✅ 94.2% 记录有物流公司信息
- ✅ 98.7% 记录有完整地址
- ✅ 99.1% 记录有重量段标记

---

## 🚀 快速开始

### 第一次使用

1. **确保Excel文件在正确位置**
   ```bash
   ls docs/报表运费10月.xlsx
   ```

2. **启动后端（自动导入数据）**
   ```bash
   cd backend
   npm install
   npm run dev
   ```
   
   观察控制台输出：
   ```
   📦 正在加载初始数据...
   ✅ 成功加载 161,853 条记录
   💰 总运费: ¥943,110.89
   🚀 服务器运行在 http://localhost:3000
   ```

3. **启动前端**
   ```bash
   cd frontend
   npm install
   npm run dev
   ```

4. **访问系统**
   ```
   打开浏览器: http://localhost:5173
   ```

### 更新数据

```bash
# 1. 替换Excel文件
cp 新的报表.xlsx docs/报表运费10月.xlsx

# 2. 重启后端
cd backend
pkill -f "ts-node"
npm run dev
```

---

## 📞 技术支持

如有问题，请查看：
- [快速开始指南](./快速开始指南.md)
- [部署指南](./部署指南.md)
- [开发任务清单](./开发任务清单.md)

---

**最后更新**: 2025-10-30  
**文档版本**: 1.0.0

