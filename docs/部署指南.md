# 运费公斤段分析系统 - 部署指南

## 🌐 生产环境部署

本文档提供了多种部署方案，您可以根据需求选择合适的方式。

## 方案一：服务器部署（推荐）

### 前置要求

- Linux 服务器（Ubuntu 20.04+ 推荐）
- Node.js 16+
- MongoDB 4.4+
- Nginx（用于反向代理）
- 域名（可选）
- SSL 证书（可选，推荐）

### 1. 服务器准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 MongoDB
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org
sudo systemctl start mongod
sudo systemctl enable mongod

# 安装 Nginx
sudo apt-get install -y nginx

# 安装 PM2（Node.js 进程管理器）
sudo npm install -g pm2
```

### 2. 部署后端

```bash
# 克隆代码
cd /var/www
sudo git clone https://github.com/tom88115/freight-weight-analyzer.git
cd freight-weight-analyzer/backend

# 安装依赖
sudo npm install

# 创建环境配置
sudo cp env.example .env
sudo nano .env
```

编辑 `.env` 文件：
```env
PORT=3000
NODE_ENV=production
MONGODB_URI=mongodb://localhost:27017/freight-analyzer
CORS_ORIGIN=https://your-domain.com
```

```bash
# 构建 TypeScript
npm run build

# 使用 PM2 启动
pm2 start dist/index.js --name freight-backend
pm2 save
pm2 startup
```

### 3. 部署前端

```bash
cd ../frontend

# 安装依赖
npm install

# 创建生产环境配置
cp env.example .env.production
nano .env.production
```

编辑 `.env.production` 文件：
```env
VITE_API_BASE_URL=https://api.your-domain.com
```

```bash
# 构建生产版本
npm run build

# 将构建文件复制到 Nginx 目录
sudo cp -r dist /var/www/freight-frontend
```

### 4. 配置 Nginx

创建 Nginx 配置文件：

```bash
sudo nano /etc/nginx/sites-available/freight-analyzer
```

添加以下配置：

```nginx
# 前端配置
server {
    listen 80;
    server_name your-domain.com;

    root /var/www/freight-frontend;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}

# 后端 API 配置
server {
    listen 80;
    server_name api.your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/freight-analyzer /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. 配置 SSL（可选但推荐）

使用 Let's Encrypt 免费 SSL 证书：

```bash
# 安装 Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com -d api.your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

## 方案二：Docker 部署

### 1. 创建 Dockerfile（后端）

在 `backend/Dockerfile` 中：

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["node", "dist/index.js"]
```

### 2. 创建 Dockerfile（前端）

在 `frontend/Dockerfile` 中：

```dockerfile
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 3. 创建 docker-compose.yml

```yaml
version: '3.8'

services:
  mongodb:
    image: mongo:6.0
    container_name: freight-mongodb
    restart: always
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"

  backend:
    build: ./backend
    container_name: freight-backend
    restart: always
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongodb:27017/freight-analyzer
      - PORT=3000
    ports:
      - "3000:3000"
    depends_on:
      - mongodb

  frontend:
    build: ./frontend
    container_name: freight-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mongodb_data:
```

### 4. 启动服务

```bash
docker-compose up -d
```

## 方案三：Vercel + MongoDB Atlas（免费方案）

### 1. 部署前端到 Vercel

```bash
# 安装 Vercel CLI
npm i -g vercel

# 进入前端目录
cd frontend

# 部署
vercel --prod
```

### 2. 设置 MongoDB Atlas

1. 访问 [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. 创建免费集群
3. 获取连接字符串

### 3. 部署后端到 Railway/Render

**使用 Railway:**
1. 访问 [Railway](https://railway.app)
2. 连接 GitHub 仓库
3. 选择 `backend` 目录
4. 设置环境变量：
   - `MONGODB_URI`: MongoDB Atlas 连接字符串
   - `CORS_ORIGIN`: Vercel 前端 URL
   - `NODE_ENV`: production

**使用 Render:**
1. 访问 [Render](https://render.com)
2. 创建新的 Web Service
3. 连接 GitHub 仓库
4. 设置：
   - Build Command: `cd backend && npm install && npm run build`
   - Start Command: `cd backend && npm start`

## 🔒 安全建议

1. **使用环境变量**
   - 不要在代码中硬编码敏感信息
   - 使用 `.env` 文件管理配置

2. **设置防火墙**
   ```bash
   sudo ufw allow 22
   sudo ufw allow 80
   sudo ufw allow 443
   sudo ufw enable
   ```

3. **配置 MongoDB 认证**
   ```bash
   # 创建管理员用户
   mongosh
   use admin
   db.createUser({
     user: "admin",
     pwd: "strong_password",
     roles: ["userAdminAnyDatabase"]
   })
   ```

4. **定期更新**
   ```bash
   sudo apt update && sudo apt upgrade
   npm update
   ```

5. **启用 HTTPS**
   - 使用 SSL 证书
   - 强制 HTTPS 重定向

## 📊 性能优化

1. **启用 Gzip 压缩**（Nginx 已配置）

2. **配置缓存**
   - 静态资源缓存
   - API 响应缓存（按需）

3. **CDN 加速**
   - 使用 Cloudflare 或其他 CDN 服务

4. **数据库优化**
   - 创建合适的索引（已在模型中配置）
   - 定期清理旧数据

## 🔄 持续部署

### GitHub Actions 示例

创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /var/www/freight-weight-analyzer
            git pull
            cd backend && npm install && npm run build
            pm2 restart freight-backend
            cd ../frontend && npm install && npm run build
            sudo cp -r dist/* /var/www/freight-frontend/
```

## 📈 监控与日志

### PM2 监控

```bash
# 查看日志
pm2 logs freight-backend

# 查看状态
pm2 status

# 监控
pm2 monit
```

### Nginx 日志

```bash
# 访问日志
sudo tail -f /var/log/nginx/access.log

# 错误日志
sudo tail -f /var/log/nginx/error.log
```

## 🆘 故障排除

### 后端无法启动

```bash
# 检查端口占用
sudo lsof -i :3000

# 检查 PM2 日志
pm2 logs freight-backend

# 检查 MongoDB 状态
sudo systemctl status mongod
```

### 前端显示异常

1. 检查 API 地址配置
2. 查看浏览器控制台错误
3. 检查 Nginx 配置

### 数据库连接失败

1. 确认 MongoDB 运行状态
2. 检查连接字符串
3. 验证网络连接和防火墙规则

## ✅ 部署检查清单

- [ ] MongoDB 正常运行
- [ ] 后端服务启动成功
- [ ] 前端构建完成
- [ ] Nginx 配置正确
- [ ] SSL 证书配置（如适用）
- [ ] 环境变量设置正确
- [ ] CORS 配置正确
- [ ] 防火墙规则配置
- [ ] 备份策略制定
- [ ] 监控系统配置

## 🎉 完成

恭喜！您的运费分析系统已成功部署到生产环境！

访问您的域名即可开始使用系统。

