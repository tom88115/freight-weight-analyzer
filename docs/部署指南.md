# è¿è´¹å…¬æ–¤æ®µåˆ†æç³»ç»Ÿ - éƒ¨ç½²æŒ‡å—

## ğŸŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

æœ¬æ–‡æ¡£æä¾›äº†å¤šç§éƒ¨ç½²æ–¹æ¡ˆï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹å¼ã€‚

## æ–¹æ¡ˆä¸€ï¼šæœåŠ¡å™¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

### å‰ç½®è¦æ±‚

- Linux æœåŠ¡å™¨ï¼ˆUbuntu 20.04+ æ¨èï¼‰
- Node.js 16+
- MongoDB 4.4+
- Nginxï¼ˆç”¨äºåå‘ä»£ç†ï¼‰
- åŸŸåï¼ˆå¯é€‰ï¼‰
- SSL è¯ä¹¦ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰

### 1. æœåŠ¡å™¨å‡†å¤‡

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£… MongoDB
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org
sudo systemctl start mongod
sudo systemctl enable mongod

# å®‰è£… Nginx
sudo apt-get install -y nginx

# å®‰è£… PM2ï¼ˆNode.js è¿›ç¨‹ç®¡ç†å™¨ï¼‰
sudo npm install -g pm2
```

### 2. éƒ¨ç½²åç«¯

```bash
# å…‹éš†ä»£ç 
cd /var/www
sudo git clone https://github.com/tom88115/freight-weight-analyzer.git
cd freight-weight-analyzer/backend

# å®‰è£…ä¾èµ–
sudo npm install

# åˆ›å»ºç¯å¢ƒé…ç½®
sudo cp env.example .env
sudo nano .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š
```env
PORT=3000
NODE_ENV=production
MONGODB_URI=mongodb://localhost:27017/freight-analyzer
CORS_ORIGIN=https://your-domain.com
```

```bash
# æ„å»º TypeScript
npm run build

# ä½¿ç”¨ PM2 å¯åŠ¨
pm2 start dist/index.js --name freight-backend
pm2 save
pm2 startup
```

### 3. éƒ¨ç½²å‰ç«¯

```bash
cd ../frontend

# å®‰è£…ä¾èµ–
npm install

# åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
cp env.example .env.production
nano .env.production
```

ç¼–è¾‘ `.env.production` æ–‡ä»¶ï¼š
```env
VITE_API_BASE_URL=https://api.your-domain.com
```

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# å°†æ„å»ºæ–‡ä»¶å¤åˆ¶åˆ° Nginx ç›®å½•
sudo cp -r dist /var/www/freight-frontend
```

### 4. é…ç½® Nginx

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ï¼š

```bash
sudo nano /etc/nginx/sites-available/freight-analyzer
```

æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```nginx
# å‰ç«¯é…ç½®
server {
    listen 80;
    server_name your-domain.com;

    root /var/www/freight-frontend;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # å‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}

# åç«¯ API é…ç½®
server {
    listen 80;
    server_name api.your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

å¯ç”¨é…ç½®ï¼š

```bash
sudo ln -s /etc/nginx/sites-available/freight-analyzer /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. é…ç½® SSLï¼ˆå¯é€‰ä½†æ¨èï¼‰

ä½¿ç”¨ Let's Encrypt å…è´¹ SSL è¯ä¹¦ï¼š

```bash
# å®‰è£… Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com -d api.your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

## æ–¹æ¡ˆäºŒï¼šDocker éƒ¨ç½²

### 1. åˆ›å»º Dockerfileï¼ˆåç«¯ï¼‰

åœ¨ `backend/Dockerfile` ä¸­ï¼š

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["node", "dist/index.js"]
```

### 2. åˆ›å»º Dockerfileï¼ˆå‰ç«¯ï¼‰

åœ¨ `frontend/Dockerfile` ä¸­ï¼š

```dockerfile
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 3. åˆ›å»º docker-compose.yml

```yaml
version: '3.8'

services:
  mongodb:
    image: mongo:6.0
    container_name: freight-mongodb
    restart: always
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"

  backend:
    build: ./backend
    container_name: freight-backend
    restart: always
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongodb:27017/freight-analyzer
      - PORT=3000
    ports:
      - "3000:3000"
    depends_on:
      - mongodb

  frontend:
    build: ./frontend
    container_name: freight-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mongodb_data:
```

### 4. å¯åŠ¨æœåŠ¡

```bash
docker-compose up -d
```

## æ–¹æ¡ˆä¸‰ï¼šVercel + MongoDB Atlasï¼ˆå…è´¹æ–¹æ¡ˆï¼‰

### 1. éƒ¨ç½²å‰ç«¯åˆ° Vercel

```bash
# å®‰è£… Vercel CLI
npm i -g vercel

# è¿›å…¥å‰ç«¯ç›®å½•
cd frontend

# éƒ¨ç½²
vercel --prod
```

### 2. è®¾ç½® MongoDB Atlas

1. è®¿é—® [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. åˆ›å»ºå…è´¹é›†ç¾¤
3. è·å–è¿æ¥å­—ç¬¦ä¸²

### 3. éƒ¨ç½²åç«¯åˆ° Railway/Render

**ä½¿ç”¨ Railway:**
1. è®¿é—® [Railway](https://railway.app)
2. è¿æ¥ GitHub ä»“åº“
3. é€‰æ‹© `backend` ç›®å½•
4. è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
   - `MONGODB_URI`: MongoDB Atlas è¿æ¥å­—ç¬¦ä¸²
   - `CORS_ORIGIN`: Vercel å‰ç«¯ URL
   - `NODE_ENV`: production

**ä½¿ç”¨ Render:**
1. è®¿é—® [Render](https://render.com)
2. åˆ›å»ºæ–°çš„ Web Service
3. è¿æ¥ GitHub ä»“åº“
4. è®¾ç½®ï¼š
   - Build Command: `cd backend && npm install && npm run build`
   - Start Command: `cd backend && npm start`

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä½¿ç”¨ç¯å¢ƒå˜é‡**
   - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
   - ä½¿ç”¨ `.env` æ–‡ä»¶ç®¡ç†é…ç½®

2. **è®¾ç½®é˜²ç«å¢™**
   ```bash
   sudo ufw allow 22
   sudo ufw allow 80
   sudo ufw allow 443
   sudo ufw enable
   ```

3. **é…ç½® MongoDB è®¤è¯**
   ```bash
   # åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
   mongosh
   use admin
   db.createUser({
     user: "admin",
     pwd: "strong_password",
     roles: ["userAdminAnyDatabase"]
   })
   ```

4. **å®šæœŸæ›´æ–°**
   ```bash
   sudo apt update && sudo apt upgrade
   npm update
   ```

5. **å¯ç”¨ HTTPS**
   - ä½¿ç”¨ SSL è¯ä¹¦
   - å¼ºåˆ¶ HTTPS é‡å®šå‘

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **å¯ç”¨ Gzip å‹ç¼©**ï¼ˆNginx å·²é…ç½®ï¼‰

2. **é…ç½®ç¼“å­˜**
   - é™æ€èµ„æºç¼“å­˜
   - API å“åº”ç¼“å­˜ï¼ˆæŒ‰éœ€ï¼‰

3. **CDN åŠ é€Ÿ**
   - ä½¿ç”¨ Cloudflare æˆ–å…¶ä»– CDN æœåŠ¡

4. **æ•°æ®åº“ä¼˜åŒ–**
   - åˆ›å»ºåˆé€‚çš„ç´¢å¼•ï¼ˆå·²åœ¨æ¨¡å‹ä¸­é…ç½®ï¼‰
   - å®šæœŸæ¸…ç†æ—§æ•°æ®

## ğŸ”„ æŒç»­éƒ¨ç½²

### GitHub Actions ç¤ºä¾‹

åˆ›å»º `.github/workflows/deploy.yml`ï¼š

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /var/www/freight-weight-analyzer
            git pull
            cd backend && npm install && npm run build
            pm2 restart freight-backend
            cd ../frontend && npm install && npm run build
            sudo cp -r dist/* /var/www/freight-frontend/
```

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

### PM2 ç›‘æ§

```bash
# æŸ¥çœ‹æ—¥å¿—
pm2 logs freight-backend

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# ç›‘æ§
pm2 monit
```

### Nginx æ—¥å¿—

```bash
# è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log

# é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

## ğŸ†˜ æ•…éšœæ’é™¤

### åç«¯æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :3000

# æ£€æŸ¥ PM2 æ—¥å¿—
pm2 logs freight-backend

# æ£€æŸ¥ MongoDB çŠ¶æ€
sudo systemctl status mongod
```

### å‰ç«¯æ˜¾ç¤ºå¼‚å¸¸

1. æ£€æŸ¥ API åœ°å€é…ç½®
2. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
3. æ£€æŸ¥ Nginx é…ç½®

### æ•°æ®åº“è¿æ¥å¤±è´¥

1. ç¡®è®¤ MongoDB è¿è¡ŒçŠ¶æ€
2. æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²
3. éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è§„åˆ™

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] MongoDB æ­£å¸¸è¿è¡Œ
- [ ] åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] å‰ç«¯æ„å»ºå®Œæˆ
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] SSL è¯ä¹¦é…ç½®ï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
- [ ] CORS é…ç½®æ­£ç¡®
- [ ] é˜²ç«å¢™è§„åˆ™é…ç½®
- [ ] å¤‡ä»½ç­–ç•¥åˆ¶å®š
- [ ] ç›‘æ§ç³»ç»Ÿé…ç½®

## ğŸ‰ å®Œæˆ

æ­å–œï¼æ‚¨çš„è¿è´¹åˆ†æç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼

è®¿é—®æ‚¨çš„åŸŸåå³å¯å¼€å§‹ä½¿ç”¨ç³»ç»Ÿã€‚

